//>>built
define("dojo/data/ObjectStore",["../_base/lang","../Evented","../_base/declare","../_base/Deferred","../_base/array","../_base/connect","../regexp"],function(e,r,a,t,i,d,l){function o(e){return"*"==e?".*":"?"==e?".":e}return a("dojo.data.ObjectStore",[r],{objectStore:null,constructor:function(r){this._dirtyObjects=[],r.labelAttribute&&(r.labelProperty=r.labelAttribute),e.mixin(this,r)},labelProperty:"label",getValue:function(e,r,a){return"function"==typeof e.get?e.get(r):r in e?e[r]:a},getValues:function(e,r){var a=this.getValue(e,r);return a instanceof Array?a:void 0===a?[]:[a]},getAttributes:function(e){var r=[];for(var a in e)!e.hasOwnProperty(a)||"_"==a.charAt(0)&&"_"==a.charAt(1)||r.push(a);return r},hasAttribute:function(e,r){return r in e},containsValue:function(e,r,a){return i.indexOf(this.getValues(e,r),a)>-1},isItem:function(e){return"object"==typeof e&&e&&!(e instanceof Date)},isItemLoaded:function(e){return e&&"function"!=typeof e.load},loadItem:function(e){var r;return"function"==typeof e.item.load?t.when(e.item.load(),function(a){r=a;var t=a instanceof Error?e.onError:e.onItem;t&&t.call(e.scope,a)}):e.onItem&&e.onItem.call(e.scope,e.item),r},close:function(e){return e&&e.abort&&e.abort()},fetch:function(r){function a(e){r.onError&&r.onError.call(n,e,r)}r=e.delegate(r,r&&r.queryOptions);var d=this,n=r.scope||d,s=r.query;if("object"==typeof s){s=e.delegate(s);for(var f in s){var m=s[f];"string"==typeof m&&(s[f]=RegExp("^"+l.escapeString(m,"*?\\").replace(/\\.|\*|\?/g,o)+"$",r.ignoreCase?"mi":"m"),s[f].toString=function(e){return function(){return e}}(m))}}var v=this.objectStore.query(s,r);return t.when(v.total,function(e){t.when(v,function(a){if(r.onBegin&&r.onBegin.call(n,e||a.length,r),r.onItem)for(var t=0;t<a.length;t++)r.onItem.call(n,a[t],r);return r.onComplete&&r.onComplete.call(n,r.onItem?null:a,r),a},a)},a),r.abort=function(){v.cancel&&v.cancel()},v.observe&&(this.observing&&this.observing.cancel(),this.observing=v.observe(function(e,r,a){if(-1==i.indexOf(d._dirtyObjects,e))if(-1==r)d.onNew(e);else if(-1==a)d.onDelete(e);else for(var t in e)t!=d.objectStore.idProperty&&d.onSet(e,t,null,e[t])},!0)),this.onFetch(v),r.store=this,r},getFeatures:function(){return{"dojo.data.api.Read":!!this.objectStore.get,"dojo.data.api.Identity":!0,"dojo.data.api.Write":!!this.objectStore.put,"dojo.data.api.Notification":!0}},getLabel:function(e){if(this.isItem(e))return this.getValue(e,this.labelProperty)},getLabelAttributes:function(e){return[this.labelProperty]},getIdentity:function(e){return this.objectStore.getIdentity?this.objectStore.getIdentity(e):e[this.objectStore.idProperty||"id"]},getIdentityAttributes:function(e){return[this.objectStore.idProperty]},fetchItemByIdentity:function(e){var r;return t.when(this.objectStore.get(e.identity),function(a){r=a,e.onItem.call(e.scope,a)},function(r){e.onError.call(e.scope,r)}),r},newItem:function(e,r){if(r){var a=this.getValue(r.parent,r.attribute,[]);a=a.concat([e]),e.__parent=a,this.setValue(r.parent,r.attribute,a)}return this._dirtyObjects.push({object:e,save:!0}),this.onNew(e),e},deleteItem:function(e){this.changing(e,!0),this.onDelete(e)},setValue:function(e,r,a){var t=e[r];this.changing(e),e[r]=a,this.onSet(e,r,t,a)},setValues:function(r,a,t){if(!e.isArray(t))throw new Error("setValues expects to be passed an Array object as its value");this.setValue(r,a,t)},unsetAttribute:function(e,r){this.changing(e);var a=e[r];delete e[r],this.onSet(e,r,a,void 0)},changing:function(e,r){e.__isDirty=!0;for(var a=0;a<this._dirtyObjects.length;a++){var t=this._dirtyObjects[a];if(e==t.object)return void(r&&(t.object=!1,this._saveNotNeeded||(t.save=!0)))}var i=e instanceof Array?[]:{};for(a in e)e.hasOwnProperty(a)&&(i[a]=e[a]);this._dirtyObjects.push({object:!r&&e,old:i,save:!this._saveNotNeeded})},save:function(e){e=e||{};var r,a=[],i=[],l=this,o=this._dirtyObjects,n=o.length;try{if(d.connect(e,"onError",function(){if(!1!==e.revertOnError){var r=o;o=i,l.revert(),l._dirtyObjects=r}else l._dirtyObjects=o.concat(i)}),this.objectStore.transaction)var s=this.objectStore.transaction();for(var f=0;f<o.length;f++){var m=o[f],v=m.object,u=m.old;delete v.__isDirty,v?r=this.objectStore.put(v,{overwrite:!!u}):void 0!==u&&(r=this.objectStore.remove(this.getIdentity(u))),i.push(m),o.splice(f--,1),t.when(r,function(r){--n||e.onComplete&&e.onComplete.call(e.scope,a)},function(r){n=-1,e.onError.call(e.scope,r)})}s&&s.commit()}catch(r){e.onError.call(e.scope,value)}},revert:function(){for(var e=this._dirtyObjects,r=e.length;r>0;){r--;var a=e[r],t=a.object,i=a.old;if(t&&i){for(var d in i)i.hasOwnProperty(d)&&t[d]!==i[d]&&(this.onSet(t,d,t[d],i[d]),t[d]=i[d]);for(d in t)i.hasOwnProperty(d)||(this.onSet(t,d,t[d]),delete t[d])}else i?this.onNew(i):this.onDelete(t);delete(t||i).__isDirty,e.splice(r,1)}},isDirty:function(e){return e?e.__isDirty:!!this._dirtyObjects.length},onSet:function(){},onNew:function(){},onDelete:function(){},onFetch:function(e){}})});//# sourceMappingURL=ObjectStore.js.map