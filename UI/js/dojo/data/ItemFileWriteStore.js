//>>built
define("dojo/data/ItemFileWriteStore",["../_base/lang","../_base/declare","../_base/array","../_base/json","../_base/kernel","./ItemFileReadStore","../date/stamp"],function(e,r,a,t,i,d,l){return r("dojo.data.ItemFileWriteStore",d,{constructor:function(e){this._features["dojo.data.api.Write"]=!0,this._features["dojo.data.api.Notification"]=!0,this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},this._datatypeMap.Date.serialize||(this._datatypeMap.Date.serialize=function(e){return l.toISOString(e,{zulu:!0})}),e&&!1===e.referenceIntegrity&&(this.referenceIntegrity=!1),this._saveInProgress=!1},referenceIntegrity:!0,_assert:function(e){if(!e)throw new Error("assertion failed in ItemFileWriteStore")},_getIdentifierAttribute:function(){return this.getFeatures()["dojo.data.api.Identity"]},newItem:function(r,a){if(this._assert(!this._saveInProgress),this._loadFinished||this._forceLoad(),"object"!=typeof r&&void 0!==r)throw new Error("newItem() was passed something other than an object");var t=null,i=this._getIdentifierAttribute();if(i===Number)t=this._arrayOfAllItems.length;else{if(void 0===(t=r[i]))throw new Error("newItem() was not passed an identity for the new item");if(e.isArray(t))throw new Error("newItem() was not passed an single-valued identity")}this._itemsByIdentity&&this._assert(void 0===this._itemsByIdentity[t]),this._assert(void 0===this._pending._newItems[t]),this._assert(void 0===this._pending._deletedItems[t]);var d={};d[this._storeRefPropName]=this,d[this._itemNumPropName]=this._arrayOfAllItems.length,this._itemsByIdentity&&(this._itemsByIdentity[t]=d,d[i]=[t]),this._arrayOfAllItems.push(d);var l=null;if(a&&a.parent&&a.attribute){l={item:a.parent,attribute:a.attribute,oldValue:void 0};var o=this.getValues(a.parent,a.attribute);if(o&&o.length>0){var n=o.slice(0,o.length);1===o.length?l.oldValue=o[0]:l.oldValue=o.slice(0,o.length),n.push(d),this._setValueOrValues(a.parent,a.attribute,n,!1),l.newValue=this.getValues(a.parent,a.attribute)}else this._setValueOrValues(a.parent,a.attribute,d,!1),l.newValue=d}else d[this._rootItemPropName]=!0,this._arrayOfTopLevelItems.push(d);this._pending._newItems[t]=d;for(var s in r){if(s===this._storeRefPropName||s===this._itemNumPropName)throw new Error("encountered bug in ItemFileWriteStore.newItem");var f=r[s];if(e.isArray(f)||(f=[f]),d[s]=f,this.referenceIntegrity)for(var m=0;m<f.length;m++){var v=f[m];this.isItem(v)&&this._addReferenceToMap(v,d,s)}}return this.onNew(d,l),d},_removeArrayElement:function(e,r){var t=a.indexOf(e,r);return-1!=t&&(e.splice(t,1),!0)},deleteItem:function(r){this._assert(!this._saveInProgress),this._assertIsItem(r);var t=r[this._itemNumPropName],i=this.getIdentity(r);if(this.referenceIntegrity){var d=this.getAttributes(r);r[this._reverseRefMap]&&(r["backup_"+this._reverseRefMap]=e.clone(r[this._reverseRefMap])),a.forEach(d,function(e){a.forEach(this.getValues(r,e),function(a){this.isItem(a)&&(r["backupRefs_"+this._reverseRefMap]||(r["backupRefs_"+this._reverseRefMap]=[]),r["backupRefs_"+this._reverseRefMap].push({id:this.getIdentity(a),attr:e}),this._removeReferenceFromMap(a,r,e))},this)},this);var l=r[this._reverseRefMap];if(l)for(var o in l){var n=null;if(n=this._itemsByIdentity?this._itemsByIdentity[o]:this._arrayOfAllItems[o])for(var s in l[o]){var f=this.getValues(n,s)||[],m=a.filter(f,function(e){return!(this.isItem(e)&&this.getIdentity(e)==i)},this);this._removeReferenceFromMap(r,n,s),m.length<f.length&&this._setValueOrValues(n,s,m,!0)}}}return this._arrayOfAllItems[t]=null,r[this._storeRefPropName]=null,this._itemsByIdentity&&delete this._itemsByIdentity[i],this._pending._deletedItems[i]=r,r[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,r),this.onDelete(r),!0},setValue:function(e,r,a){return this._setValueOrValues(e,r,a,!0)},setValues:function(e,r,a){return this._setValueOrValues(e,r,a,!0)},unsetAttribute:function(e,r){return this._setValueOrValues(e,r,[],!0)},_setValueOrValues:function(r,t,i,d){this._assert(!this._saveInProgress),this._assertIsItem(r),this._assert(e.isString(t)),this._assert(void 0!==i);var l=this._getIdentifierAttribute();if(t==l)throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");var o=this._getValueOrValues(r,t),n=this.getIdentity(r);if(!this._pending._modifiedItems[n]){var s={};for(var f in r)f===this._storeRefPropName||f===this._itemNumPropName||f===this._rootItemPropName?s[f]=r[f]:f===this._reverseRefMap?s[f]=e.clone(r[f]):s[f]=r[f].slice(0,r[f].length);this._pending._modifiedItems[n]=s}var m=!1;if(e.isArray(i)&&0===i.length){if(m=delete r[t],i=void 0,this.referenceIntegrity&&o){var v=o;e.isArray(v)||(v=[v]);for(var u=0;u<v.length;u++){var h=v[u];this.isItem(h)&&this._removeReferenceFromMap(h,r,t)}}}else{var y;if(y=e.isArray(i)?i.slice(0,i.length):[i],this.referenceIntegrity)if(o){var v=o;e.isArray(v)||(v=[v]);var w={};a.forEach(v,function(e){if(this.isItem(e)){var r=this.getIdentity(e);w[r.toString()]=!0}},this),a.forEach(y,function(e){if(this.isItem(e)){var a=this.getIdentity(e);w[a.toString()]?delete w[a.toString()]:this._addReferenceToMap(e,r,t)}},this);for(var M in w){var c;c=this._itemsByIdentity?this._itemsByIdentity[M]:this._arrayOfAllItems[M],this._removeReferenceFromMap(c,r,t)}}else for(var u=0;u<y.length;u++){var h=y[u];this.isItem(h)&&this._addReferenceToMap(h,r,t)}r[t]=y,m=!0}return d&&this.onSet(r,t,o,i),m},_addReferenceToMap:function(e,r,a){var t=this.getIdentity(r),i=e[this._reverseRefMap];i||(i=e[this._reverseRefMap]={});var d=i[t];d||(d=i[t]={}),d[a]=!0},_removeReferenceFromMap:function(e,r,a){var t,i=this.getIdentity(r),d=e[this._reverseRefMap];if(d){for(t in d)t==i&&(delete d[t][a],this._isEmpty(d[t])&&delete d[t]);this._isEmpty(d)&&delete e[this._reverseRefMap]}},_dumpReferenceMap:function(){var e;for(e=0;e<this._arrayOfAllItems.length;e++){var r=this._arrayOfAllItems[e];r&&r[this._reverseRefMap]}},_getValueOrValues:function(e,r){var a=void 0;if(this.hasAttribute(e,r)){var t=this.getValues(e,r);a=1==t.length?t[0]:t}return a},_flatten:function(r){if(this.isItem(r))return{_reference:this.getIdentity(r)};if("object"==typeof r)for(var a in this._datatypeMap){var t=this._datatypeMap[a];if(e.isObject(t)&&!e.isFunction(t)){if(r instanceof t.type){if(!t.serialize)throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+a+"]");return{_type:a,_value:t.serialize(r)}}}else if(r instanceof t)return{_type:a,_value:r.toString()}}return r},_getNewFileContentString:function(){var e={},r=this._getIdentifierAttribute();r!==Number&&(e.identifier=r),this._labelAttr&&(e.label=this._labelAttr),e.items=[];for(var a=0;a<this._arrayOfAllItems.length;++a){var i=this._arrayOfAllItems[a];if(null!==i){var d={};for(var l in i)if(l!==this._storeRefPropName&&l!==this._itemNumPropName&&l!==this._reverseRefMap&&l!==this._rootItemPropName){var o=this.getValues(i,l);if(1==o.length)d[l]=this._flatten(o[0]);else for(var n=[],s=0;s<o.length;++s)n.push(this._flatten(o[s])),d[l]=n}e.items.push(d)}}return t.toJson(e,!0)},_isEmpty:function(r){var a=!0;if(e.isObject(r)){var t;for(t in r){a=!1;break}}else e.isArray(r)&&r.length>0&&(a=!1);return a},save:function(e){this._assert(!this._saveInProgress),this._saveInProgress=!0;var r=this,a=function(){if(r._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},r._saveInProgress=!1,e&&e.onComplete){var a=e.scope||i.global;e.onComplete.call(a)}},t=function(a){if(r._saveInProgress=!1,e&&e.onError){var t=e.scope||i.global;e.onError.call(t,a)}};if(this._saveEverything){var d=this._getNewFileContentString();this._saveEverything(a,t,d)}this._saveCustom&&this._saveCustom(a,t),this._saveEverything||this._saveCustom||a()},revert:function(){this._assert(!this._saveInProgress);var r;for(r in this._pending._modifiedItems){var t=this._pending._modifiedItems[r],i=null;i=this._itemsByIdentity?this._itemsByIdentity[r]:this._arrayOfAllItems[r],t[this._storeRefPropName]=this;for(var d in i)delete i[d];e.mixin(i,t)}var l;for(r in this._pending._deletedItems){l=this._pending._deletedItems[r],l[this._storeRefPropName]=this;var o=l[this._itemNumPropName];l["backup_"+this._reverseRefMap]&&(l[this._reverseRefMap]=l["backup_"+this._reverseRefMap],delete l["backup_"+this._reverseRefMap]),this._arrayOfAllItems[o]=l,this._itemsByIdentity&&(this._itemsByIdentity[r]=l),l[this._rootItemPropName]&&this._arrayOfTopLevelItems.push(l)}for(r in this._pending._deletedItems)l=this._pending._deletedItems[r],l["backupRefs_"+this._reverseRefMap]&&(a.forEach(l["backupRefs_"+this._reverseRefMap],function(e){var r;r=this._itemsByIdentity?this._itemsByIdentity[e.id]:this._arrayOfAllItems[e.id],this._addReferenceToMap(r,l,e.attr)},this),delete l["backupRefs_"+this._reverseRefMap]);for(r in this._pending._newItems){var n=this._pending._newItems[r];n[this._storeRefPropName]=null,this._arrayOfAllItems[n[this._itemNumPropName]]=null,n[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,n),this._itemsByIdentity&&delete this._itemsByIdentity[r]}return this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},!0},isDirty:function(e){if(e){var r=this.getIdentity(e);return new Boolean(this._pending._newItems[r]||this._pending._modifiedItems[r]||this._pending._deletedItems[r]).valueOf()}return!this._isEmpty(this._pending._newItems)||!this._isEmpty(this._pending._modifiedItems)||!this._isEmpty(this._pending._deletedItems)},onSet:function(e,r,a,t){},onNew:function(e,r){},onDelete:function(e){},close:function(e){if(this.clearOnClose){if(this.isDirty())throw new Error("dojo.data.ItemFileWriteStore: There are unsaved changes present in the store.  Please save or revert the changes before invoking close.");this.inherited(arguments)}}})});//# sourceMappingURL=ItemFileWriteStore.js.map