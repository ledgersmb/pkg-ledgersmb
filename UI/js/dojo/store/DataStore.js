//>>built
define("dojo/store/DataStore",["../_base/lang","../_base/declare","../Deferred","../_base/array","./util/QueryResults","./util/SimpleQueryEngine"],function(e,r,a,t,i,d){return r("dojo.store.DataStore",null,{target:"",constructor:function(r){if(e.mixin(this,r),!("idProperty"in r)){var a;try{a=this.store.getIdentityAttributes()}catch(e){}this.idProperty=(e.isArray(a)?a[0]:a)||this.idProperty}var t=this.store.getFeatures();t["dojo.data.api.Read"]||(this.get=null),t["dojo.data.api.Identity"]||(this.getIdentity=null),t["dojo.data.api.Write"]||(this.put=this.add=null)},idProperty:"id",store:null,queryEngine:d,_objectConverter:function(e){function r(e){for(var i={},d=a.getAttributes(e),l=0;l<d.length;l++){var o=d[l],n=a.getValues(e,o);if(n.length>1){for(var s=0;s<n.length;s++){var f=n[s];"object"==typeof f&&a.isItem(f)&&(n[s]=r(f))}f=n}else{var f=a.getValue(e,o);"object"==typeof f&&a.isItem(f)&&(f=r(f))}i[d[l]]=f}return t in i||!a.getIdentity||(i[t]=a.getIdentity(e)),i}var a=this.store,t=this.idProperty;return function(a){return e(a&&r(a))}},get:function(e,r){var t,i,d=new a;if(this.store.fetchItemByIdentity({identity:e,onItem:this._objectConverter(function(e){d.resolve(t=e)}),onError:function(e){d.reject(i=e)}}),void 0!==t)return null==t?void 0:t;if(i)throw i;return d.promise},put:function(e,r){r=r||{};var t=void 0!==r.id?r.id:this.getIdentity(e),i=this.store,d=this.idProperty,l=new a;if(void 0===t){var o=i.newItem(e);i.save({onComplete:function(){l.resolve(o)},onError:function(e){l.reject(e)}})}else i.fetchItemByIdentity({identity:t,onItem:function(a){if(a){if(!1===r.overwrite)return l.reject(new Error("Overwriting existing object not allowed"));for(var t in e)t!=d&&e.hasOwnProperty(t)&&i.getValue(a,t)!=e[t]&&i.setValue(a,t,e[t])}else{if(!0===r.overwrite)return l.reject(new Error("Creating new object not allowed"));var a=i.newItem(e)}i.save({onComplete:function(){l.resolve(a)},onError:function(e){l.reject(e)}})},onError:function(e){l.reject(e)}});return l.promise},add:function(e,r){return(r=r||{}).overwrite=!1,this.put(e,r)},remove:function(e){var r=this.store,t=new a;return this.store.fetchItemByIdentity({identity:e,onItem:function(e){try{null==e?t.resolve(!1):(r.deleteItem(e),r.save(),t.resolve(!0))}catch(e){t.reject(e)}},onError:function(e){t.reject(e)}}),t.promise},query:function(r,d){var l,o=new a(function(){l.abort&&l.abort()});o.total=new a;var n=this._objectConverter(function(e){return e});return l=this.store.fetch(e.mixin({query:r,onBegin:function(e){o.total.resolve(e)},onComplete:function(e){o.resolve(t.map(e,n))},onError:function(e){o.reject(e)}},d)),i(o)},getIdentity:function(e){return e[this.idProperty]}})});//# sourceMappingURL=DataStore.js.map