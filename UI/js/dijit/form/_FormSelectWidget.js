//>>built
define("dijit/form/_FormSelectWidget",["dojo/_base/array","dojo/_base/Deferred","dojo/aspect","dojo/data/util/sorter","dojo/_base/declare","dojo/dom","dojo/dom-class","dojo/_base/kernel","dojo/_base/lang","dojo/query","dojo/when","dojo/store/util/QueryResults","./_FormValueWidget"],function(e,t,r,a,i,d,l,o,n,s,f,m,u){return i("dijit.form._FormSelectWidget",u,{multiple:!1,options:null,store:null,_setStoreAttr:function(e){this._created&&this._deprecatedSetStore(e)},query:null,_setQueryAttr:function(e){this._created&&this._deprecatedSetStore(this.store,this.selectedValue,{query:e})},queryOptions:null,_setQueryOptionsAttr:function(e){this._created&&this._deprecatedSetStore(this.store,this.selectedValue,{queryOptions:e})},labelAttr:"",onFetch:null,sortByLabel:!0,loadChildrenOnOpen:!1,onLoadDeferred:null,getOptions:function(t){var r=this.options||[];return null==t?r:n.isArrayLike(t)?e.map(t,"return this.getOptions(item);",this):(n.isString(t)&&(t={value:t}),n.isObject(t)&&(e.some(r,function(e,r){for(var a in t)if(!(a in e)||e[a]!=t[a])return!1;return t=r,!0})||(t=-1)),t>=0&&t<r.length?r[t]:null)},addOption:function(t){e.forEach(n.isArrayLike(t)?t:[t],function(e){e&&n.isObject(e)&&this.options.push(e)},this),this._loadChildren()},removeOption:function(t){var r=this.getOptions(n.isArrayLike(t)?t:[t]);e.forEach(r,function(t){t&&(this.options=e.filter(this.options,function(e){return e.value!==t.value||e.label!==t.label}),this._removeOptionItem(t))},this),this._loadChildren()},updateOption:function(t){e.forEach(n.isArrayLike(t)?t:[t],function(e){var t,r=this.getOptions({value:e.value});if(r)for(t in e)r[t]=e[t]},this),this._loadChildren()},setStore:function(e,t,r){o.deprecated(this.declaredClass+"::setStore(store, selectedValue, fetchArgs) is deprecated. Use set('query', fetchArgs.query), set('queryOptions', fetchArgs.queryOptions), set('store', store), or set('value', selectedValue) instead.","","2.0"),this._deprecatedSetStore(e,t,r)},_deprecatedSetStore:function(i,d,l){var o=this.store;if(l=l||{},o!==i){for(var s;s=this._notifyConnections.pop();)s.remove();i.get||(n.mixin(i,{_oldAPI:!0,get:function(e){var r=new t;return this.fetchItemByIdentity({identity:e,onItem:function(e){r.resolve(e)},onError:function(e){r.reject(e)}}),r.promise},query:function(e,r){var a=new t(function(){i.abort&&i.abort()});a.total=new t;var i=this.fetch(n.mixin({query:e,onBegin:function(e){a.total.resolve(e)},onComplete:function(e){a.resolve(e)},onError:function(e){a.reject(e)}},r));return new m(a)}}),i.getFeatures()["dojo.data.api.Notification"]&&(this._notifyConnections=[r.after(i,"onNew",n.hitch(this,"_onNewItem"),!0),r.after(i,"onDelete",n.hitch(this,"_onDeleteItem"),!0),r.after(i,"onSet",n.hitch(this,"_onSetItem"),!0)])),this._set("store",i)}return this.options&&this.options.length&&this.removeOption(this.options),this._queryRes&&this._queryRes.close&&this._queryRes.close(),this._observeHandle&&this._observeHandle.remove&&(this._observeHandle.remove(),this._observeHandle=null),l.query&&this._set("query",l.query),l.queryOptions&&this._set("queryOptions",l.queryOptions),i&&i.query&&(this._loadingStore=!0,this.onLoadDeferred=new t,this._queryRes=i.query(this.query,this.queryOptions),f(this._queryRes,n.hitch(this,function(t){if(this.sortByLabel&&!l.sort&&t.length)if(i.getValue)t.sort(a.createSortFunction([{attribute:i.getLabelAttributes(t[0])[0]}],i));else{var r=this.labelAttr;t.sort(function(e,t){return e[r]>t[r]?1:t[r]>e[r]?-1:0})}l.onFetch&&(t=l.onFetch.call(this,t,l)),e.forEach(t,function(e){this._addOptionForItem(e)},this),this._queryRes.observe&&(this._observeHandle=this._queryRes.observe(n.hitch(this,function(e,t,r){t==r?this._onSetItem(e):(-1!=t&&this._onDeleteItem(e),-1!=r&&this._onNewItem(e))}),!0)),this._loadingStore=!1,this.set("value","_pendingValue"in this?this._pendingValue:d),delete this._pendingValue,this.loadChildrenOnOpen?this._pseudoLoadChildren(t):this._loadChildren(),this.onLoadDeferred.resolve(!0),this.onSetStore()}),n.hitch(this,function(e){console.error("dijit.form.Select: "+e.toString()),this.onLoadDeferred.reject(e)}))),o},_setValueAttr:function(t,r){if(this._onChangeActive||(r=null),this._loadingStore)return void(this._pendingValue=t);if(null!=t){t=n.isArrayLike(t)?e.map(t,function(e){return n.isObject(e)?e:{value:e}}):n.isObject(t)?[t]:[{value:t}],t=e.filter(this.getOptions(t),function(e){return e&&e.value});var a=this.getOptions()||[];this.multiple||t[0]&&t[0].value||!a.length||(t[0]=a[0]),e.forEach(a,function(r){r.selected=e.some(t,function(e){return e.value===r.value})});var i=e.map(t,function(e){return e.value});if(void 0!==i&&void 0!==i[0]){var d=e.map(t,function(e){return e.label});this._setDisplay(this.multiple?d:d[0]),this.inherited(arguments,[this.multiple?i:i[0],r]),this._updateSelection()}}},_getDisplayedValueAttr:function(){var t=e.map([].concat(this.get("selectedOptions")),function(e){return e&&"label"in e?e.label:e?e.value:null},this);return this.multiple?t:t[0]},_setDisplayedValueAttr:function(e){this.set("value",this.getOptions("string"==typeof e?{label:e}:e))},_loadChildren:function(){this._loadingStore||(e.forEach(this._getChildren(),function(e){e.destroyRecursive()}),e.forEach(this.options,this._addOptionItem,this),this._updateSelection())},_updateSelection:function(){this.focusedChild=null,this._set("value",this._getValueFromOpts());var t=[].concat(this.value);if(t&&t[0]){var r=this;e.forEach(this._getChildren(),function(a){var i=e.some(t,function(e){return a.option&&e===a.option.value});i&&!r.multiple&&(r.focusedChild=a),l.toggle(a.domNode,this.baseClass.replace(/\s+|$/g,"SelectedOption "),i),a.domNode.setAttribute("aria-selected",i?"true":"false")},this)}},_getValueFromOpts:function(){var t=this.getOptions()||[];if(!this.multiple&&t.length){var r=e.filter(t,function(e){return e.selected})[0];return r&&r.value?r.value:(t[0].selected=!0,t[0].value)}return this.multiple?e.map(e.filter(t,function(e){return e.selected}),function(e){return e.value})||[]:""},_onNewItem:function(e,t){t&&t.parent||this._addOptionForItem(e)},_onDeleteItem:function(e){var t=this.store;this.removeOption({value:t.getIdentity(e)})},_onSetItem:function(e){this.updateOption(this._getOptionObjForItem(e))},_getOptionObjForItem:function(e){var t=this.store,r=this.labelAttr&&this.labelAttr in e?e[this.labelAttr]:t.getLabel(e);return{value:r?t.getIdentity(e):null,label:r,item:e}},_addOptionForItem:function(e){var t=this.store;if(t.isItemLoaded&&!t.isItemLoaded(e))return void t.loadItem({item:e,onItem:function(e){this._addOptionForItem(e)},scope:this});var r=this._getOptionObjForItem(e);this.addOption(r)},constructor:function(e){this._oValue=(e||{}).value||null,this._notifyConnections=[]},buildRendering:function(){this.inherited(arguments),d.setSelectable(this.focusNode,!1)},_fillContent:function(){this.options||(this.options=this.srcNodeRef?s("> *",this.srcNodeRef).map(function(e){return"separator"===e.getAttribute("type")?{value:"",label:"",selected:!1,disabled:!1}:{value:e.getAttribute("data-"+o._scopeName+"-value")||e.getAttribute("value"),label:String(e.innerHTML),selected:e.getAttribute("selected")||!1,disabled:e.getAttribute("disabled")||!1}},this):[]),this.value?this.multiple&&"string"==typeof this.value&&this._set("value",this.value.split(",")):this._set("value",this._getValueFromOpts())},postCreate:function(){this.inherited(arguments),r.after(this,"onChange",n.hitch(this,"_updateSelection"));var e=this.store;e&&(e.getIdentity||e.getFeatures()["dojo.data.api.Identity"])&&(this.store=null,this._deprecatedSetStore(e,this._oValue,{query:this.query,queryOptions:this.queryOptions})),this._storeInitialized=!0},startup:function(){this._loadChildren(),this.inherited(arguments)},destroy:function(){for(var e;e=this._notifyConnections.pop();)e.remove();this._queryRes&&this._queryRes.close&&this._queryRes.close(),this._observeHandle&&this._observeHandle.remove&&(this._observeHandle.remove(),this._observeHandle=null),this.inherited(arguments)},_addOptionItem:function(){},_removeOptionItem:function(){},_setDisplay:function(){},_getChildren:function(){return[]},_getSelectedOptionsAttr:function(){return this.getOptions({selected:!0})},_pseudoLoadChildren:function(){},onSetStore:function(){}})});//# sourceMappingURL=_FormSelectWidget.js.map