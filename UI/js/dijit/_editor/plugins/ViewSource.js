//>>built
define("dijit/_editor/plugins/ViewSource",["dojo/_base/array","dojo/aspect","dojo/_base/declare","dojo/dom-attr","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/i18n","dojo/keys","dojo/_base/lang","dojo/on","dojo/sniff","dojo/window","../../focus","../_Plugin","../../form/ToggleButton","../..","../../registry","dojo/i18n!../nls/commands"],function(e,t,r,a,i,d,l,o,n,s,f,m,u,v,h,y,w,c){var M=r("dijit._editor.plugins.ViewSource",h,{stripScripts:!0,stripComments:!0,stripIFrames:!0,stripEventHandlers:!0,readOnly:!1,_fsPlugin:null,toggle:function(){m("webkit")&&(this._vsFocused=!0),this.button.set("checked",!this.button.get("checked"))},_initButton:function(){var e=o.getLocalization("dijit._editor","commands"),t=this.editor;this.button=new y({label:e.viewSource,ownerDocument:t.ownerDocument,dir:t.dir,lang:t.lang,showLabel:!1,iconClass:this.iconClassPrefix+" "+this.iconClassPrefix+"ViewSource",tabIndex:"-1",onChange:s.hitch(this,"_showSource")}),this.button.set("readOnly",!1)},setEditor:function(e){this.editor=e,this._initButton(),this.removeValueFilterHandles(),this._setValueFilterHandle=t.before(this.editor,"setValue",s.hitch(this,function(e){return[this._filter(e)]})),this._getValueFilterHandle=t.after(this.editor,"getValue",s.hitch(this,function(e){return this._filter(e)})),this.editor.addKeyHandler(n.F12,!0,!0,s.hitch(this,function(e){this.button.focus(),this.toggle(),e.stopPropagation(),e.preventDefault(),setTimeout(s.hitch(this,function(){this.editor.focused&&this.editor.focus()}),100)}))},_showSource:function(r){var a,i=this.editor,d=i._plugins;this._sourceShown=r;var o=this;try{if(this.sourceArea||this._createSourceView(),r){i._sourceQueryCommandEnabled=i.queryCommandEnabled,i.queryCommandEnabled=function(e){return"viewsource"===e.toLowerCase()},this.editor.onDisplayChanged(),e.forEach(d,function(e){!e||e instanceof M||!e.isInstanceOf(h)||e.set("disabled",!0)}),this._fsPlugin&&(this._fsPlugin._getAltViewNode=function(){return o.sourceArea}),this.sourceArea.value=i.get("value"),this.sourceArea.style.height=i.iframe.style.height,this.sourceArea.style.width=i.iframe.style.width,i.iframe.parentNode.style.position="relative",l.set(i.iframe,{position:"absolute",top:0,visibility:"hidden"}),l.set(this.sourceArea,{display:"block"});var n=function(){var e=u.getBox(i.ownerDocument);if("_prevW"in this&&"_prevH"in this){if(e.w===this._prevW&&e.h===this._prevH)return;this._prevW=e.w,this._prevH=e.h}else this._prevW=e.w,this._prevH=e.h;this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizer=setTimeout(s.hitch(this,function(){delete this._resizer,this._resize()}),10)};this._resizeHandle=f(window,"resize",s.hitch(this,n)),setTimeout(s.hitch(this,this._resize),100),this.editor.onNormalizedDisplayChanged(),this.editor.__oldGetValue=this.editor.getValue,this.editor.getValue=s.hitch(this,function(){var e=this.sourceArea.value;return e=this._filter(e)}),this._setListener=t.after(this.editor,"setValue",s.hitch(this,function(e){e=e||"",this.sourceArea.value=e}),!0)}else{if(!i._sourceQueryCommandEnabled)return;this._setListener.remove(),delete this._setListener,this._resizeHandle.remove(),delete this._resizeHandle,this.editor.__oldGetValue&&(this.editor.getValue=this.editor.__oldGetValue,delete this.editor.__oldGetValue),i.queryCommandEnabled=i._sourceQueryCommandEnabled,this._readOnly||(a=this.sourceArea.value,i.beginEditing(),i.set("value",a),i.endEditing()),e.forEach(d,function(e){e&&e.isInstanceOf(h)&&e.set("disabled",!1)}),l.set(this.sourceArea,"display","none"),l.set(i.iframe,{position:"relative",visibility:"visible"}),delete i._sourceQueryCommandEnabled,this.editor.onDisplayChanged()}setTimeout(s.hitch(this,function(){var e=i.domNode.parentNode;if(e){var t=c.getEnclosingWidget(e);t&&t.resize&&t.resize()}i.resize()}),300)}catch(e){}},updateState:function(){this.button.set("disabled",this.get("disabled"))},_resize:function(){var e=this.editor,t=e.getHeaderHeight(),r=e.getFooterHeight(),a=d.position(e.domNode),i=d.getPadBorderExtents(e.iframe.parentNode),l=d.getMarginExtents(e.iframe.parentNode),o=d.getPadBorderExtents(e.domNode),n={w:a.w-o.w,h:a.h-(t+o.h+r)};if(this._fsPlugin&&this._fsPlugin.isFullscreen){var s=u.getBox(e.ownerDocument);n.w=s.w-o.w,n.h=s.h-(t+o.h+r)}d.setMarginBox(this.sourceArea,{w:Math.round(n.w-(i.w+l.w)),h:Math.round(n.h-(i.h+l.h))})},_createSourceView:function(){var e=this.editor,t=e._plugins;this.sourceArea=i.create("textarea"),this.readOnly&&(a.set(this.sourceArea,"readOnly",!0),this._readOnly=!0),l.set(this.sourceArea,{padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),a.set(this.sourceArea,"aria-label",this.editor.id),i.place(this.sourceArea,e.iframe,"before"),m("ie")&&e.iframe.parentNode.lastChild!==e.iframe&&l.set(e.iframe.parentNode.lastChild,{width:"0px",height:"0px",padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),e._viewsource_oldFocus=e.focus;var r=this;e.focus=function(){if(r._sourceShown)r.setSourceAreaCaret();else try{this._vsFocused?(delete this._vsFocused,v.focus(e.editNode)):e._viewsource_oldFocus()}catch(e){}};var d,o;for(d=0;d<t.length;d++)if((o=t[d])&&("dijit._editor.plugins.FullScreen"===o.declaredClass||o.declaredClass===w._scopeName+"._editor.plugins.FullScreen")){this._fsPlugin=o;break}this._fsPlugin&&(this._fsPlugin._viewsource_getAltViewNode=this._fsPlugin._getAltViewNode,this._fsPlugin._getAltViewNode=function(){return r._sourceShown?r.sourceArea:this._viewsource_getAltViewNode()}),this.own(f(this.sourceArea,"keydown",s.hitch(this,function(t){this._sourceShown&&t.keyCode==n.F12&&t.ctrlKey&&t.shiftKey&&(this.button.focus(),this.button.set("checked",!1),setTimeout(s.hitch(this,function(){e.focus()}),100),t.stopPropagation(),t.preventDefault())})))},_stripScripts:function(e){return e&&(e=e.replace(/<\s*script[^>]*>((.|\s)*?)<\\?\/\s*script\s*>/gi,""),e=e.replace(/<\s*script\b([^<>]|\s)*>?/gi,""),e=e.replace(/<[^>]*=(\s|)*[("|')]javascript:[^$1][(\s|.)]*[$1][^>]*>/gi,"")),e},_stripComments:function(e){return e&&(e=e.replace(/<!--(.|\s){1,}?-->/g,"")),e},_stripIFrames:function(e){return e&&(e=e.replace(/<\s*iframe[^>]*>((.|\s)*?)<\\?\/\s*iframe\s*>/gi,"")),e},_stripEventHandlers:function(e){if(e){var t=e.match(/<[a-z]+?\b(.*?on.*?(['"]).*?\2.*?)+>/gim);if(t)for(var r=0,a=t.length;r<a;r++){var i=t[r],d=i.replace(/\s+on[a-z]*\s*=\s*(['"])(.*?)\1/gim,"");e=e.replace(i,d)}}return e},_filter:function(e){return e&&(this.stripScripts&&(e=this._stripScripts(e)),this.stripComments&&(e=this._stripComments(e)),this.stripIFrames&&(e=this._stripIFrames(e)),this.stripEventHandlers&&(e=this._stripEventHandlers(e))),e},removeValueFilterHandles:function(){this._setValueFilterHandle&&(this._setValueFilterHandle.remove(),delete this._setValueFilterHandle),this._getValueFilterHandle&&(this._getValueFilterHandle.remove(),delete this._getValueFilterHandle)},setSourceAreaCaret:function(){var e=this.sourceArea;if(v.focus(e),this._sourceShown&&!this.readOnly)if(e.setSelectionRange)e.setSelectionRange(0,0);else if(this.sourceArea.createTextRange){var t=e.createTextRange();t.collapse(!0),t.moveStart("character",-99999),t.moveStart("character",0),t.moveEnd("character",0),t.select()}},destroy:function(){this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizeHandle&&(this._resizeHandle.remove(),delete this._resizeHandle),this._setListener&&(this._setListener.remove(),delete this._setListener),this.removeValueFilterHandles(),this.inherited(arguments)}});return h.registry.viewSource=h.registry.viewsource=function(e){return new M({readOnly:"readOnly"in e&&e.readOnly,stripComments:!("stripComments"in e)||e.stripComments,stripScripts:!("stripScripts"in e)||e.stripScripts,stripIFrames:!("stripIFrames"in e)||e.stripIFrames,stripEventHandlers:!("stripEventHandlers"in e)||e.stripEventHandlers})},M});//# sourceMappingURL=ViewSource.js.map