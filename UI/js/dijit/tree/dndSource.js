//>>built
define("dijit/tree/dndSource",["dojo/_base/array","dojo/_base/declare","dojo/dnd/common","dojo/dom-class","dojo/dom-geometry","dojo/_base/lang","dojo/mouse","dojo/on","dojo/touch","dojo/topic","dojo/dnd/Manager","./_dndSelector"],function(e,t,r,a,i,d,l,o,n,s,f,m){return t("dijit.tree.dndSource",m,{isSource:!0,accept:["text","treeNode"],copyOnly:!1,dragThreshold:5,betweenThreshold:0,generateText:!0,constructor:function(e,t){t||(t={}),d.mixin(this,t);var r=t.accept instanceof Array?t.accept:["text","treeNode"];if(this.accept=null,r.length){this.accept={};for(var i=0;i<r.length;++i)this.accept[r[i]]=1}this.isDragging=!1,this.mouseDown=!1,this.targetAnchor=null,this.targetBox=null,this.dropPosition="",this._lastX=0,this._lastY=0,this.sourceState="",this.isSource&&a.add(this.node,"dojoDndSource"),this.targetState="",this.accept&&a.add(this.node,"dojoDndTarget"),this.topics=[s.subscribe("/dnd/source/over",d.hitch(this,"onDndSourceOver")),s.subscribe("/dnd/start",d.hitch(this,"onDndStart")),s.subscribe("/dnd/drop",d.hitch(this,"onDndDrop")),s.subscribe("/dnd/cancel",d.hitch(this,"onDndCancel"))]},checkAcceptance:function(){return!0},copyState:function(e){return this.copyOnly||e},destroy:function(){this.inherited(arguments);for(var e;e=this.topics.pop();)e.remove();this.targetAnchor=null},_onDragMouse:function(e,t){var r=f.manager(),a=this.targetAnchor,d=this.current,l=this.dropPosition,o="Over";if(d&&this.betweenThreshold>0&&(this.targetBox&&a==d||(this.targetBox=i.position(d.rowNode,!0)),e.pageY-this.targetBox.y<=this.betweenThreshold?o="Before":e.pageY-this.targetBox.y>=this.targetBox.h-this.betweenThreshold&&(o="After")),t||d!=a||o!=l){if(a&&this._removeItemClass(a.rowNode,l),d&&this._addItemClass(d.rowNode,o),d)if(d==this.tree.rootNode&&"Over"!=o)r.canDrop(!1);else{var n=!1,s=!1;if(r.source==this){s="Over"===o;for(var m in this.selection){var u=this.selection[m];if(u.item===d.item){n=!0;break}u.getParent().id!==d.id&&(s=!1)}}r.canDrop(!n&&!s&&!this._isParentChildDrop(r.source,d.rowNode)&&this.checkItemAcceptance(d.rowNode,r.source,o.toLowerCase()))}else r.canDrop(!1);this.targetAnchor=d,this.dropPosition=o}},onMouseMove:function(t){if(!this.isDragging||"Disabled"!=this.targetState){this.inherited(arguments);var a=f.manager();if(this.isDragging)this._onDragMouse(t);else if(this.mouseDown&&this.isSource&&(Math.abs(t.pageX-this._lastX)>=this.dragThreshold||Math.abs(t.pageY-this._lastY)>=this.dragThreshold)){var i=this.getSelectedTreeNodes();if(i.length){if(i.length>1){var d,l,o=this.selection,n=0,s=[];e:for(;d=i[n++];){for(l=d.getParent();l&&l!==this.tree;l=l.getParent())if(o[l.id])continue e;s.push(d)}i=s}i=e.map(i,function(e){return e.domNode}),a.startDrag(this,i,this.copyState(r.getCopyKeyState(t))),this._onDragMouse(t,!0)}}}},onMouseDown:function(e){("touchstart"==e.type||l.isLeft(e))&&(this.mouseDown=!0,this.mouseButton=e.button,this._lastX=e.pageX,this._lastY=e.pageY),this.inherited(arguments)},onMouseUp:function(e){this.mouseDown&&(this.mouseDown=!1,this.inherited(arguments))},onMouseOut:function(){this.inherited(arguments),this._unmarkTargetAnchor()},checkItemAcceptance:function(){return!0},onDndSourceOver:function(e){if(this!=e)this.mouseDown=!1,this._unmarkTargetAnchor();else if(this.isDragging){var t=f.manager();t.canDrop(!1)}},onDndStart:function(e,t,r){this.isSource&&this._changeState("Source",this==e?r?"Copied":"Moved":"");var a=this.checkAcceptance(e,t);this._changeState("Target",a?"":"Disabled"),this==e&&f.manager().overSource(this),this.isDragging=!0},itemCreator:function(t){return e.map(t,function(e){return{id:e.id,name:e.textContent||e.innerText||""}})},onDndDrop:function(t,r,a){if("Over"==this.containerState){var i=this.tree,d=i.model,l=this.targetAnchor,o=!1;this.isDragging=!1;var n,s,f;n=l&&l.item||i.item,"Before"==this.dropPosition||"After"==this.dropPosition?(n=l.getParent()&&l.getParent().item||i.item,s=l.getIndexInParent(),"After"==this.dropPosition?(s=l.getIndexInParent()+1,f=l.getNextSibling()&&l.getNextSibling().item):f=l.item):(n=l&&l.item||i.item,o=!0);var m;e.forEach(r,function(i,o){var u=t.getItem(i.id);if(-1!=e.indexOf(u.type,"treeNode"))var h=u.data,v=h.item,y=h.getParent().item;t==this?("number"==typeof s&&n==y&&h.getIndexInParent()<s&&(s-=1),d.pasteItem(v,y,n,a,s,f)):d.isItem(v)?d.pasteItem(v,y,n,a,s,f):(m||(m=this.itemCreator(r,l.rowNode,t)),d.newItem(m[o],n,s,f))},this),o&&this.tree._expandNode(l)}this.onDndCancel()},onDndCancel:function(){this._unmarkTargetAnchor(),this.isDragging=!1,this.mouseDown=!1,delete this.mouseButton,this._changeState("Source",""),this._changeState("Target","")},onOverEvent:function(){this.inherited(arguments),f.manager().overSource(this)},onOutEvent:function(){this._unmarkTargetAnchor();var e=f.manager();this.isDragging&&e.canDrop(!1),e.outSource(this),this.inherited(arguments)},_isParentChildDrop:function(e,t){if(!e.tree||e.tree!=this.tree)return!1;for(var r=e.tree.domNode,a=e.selection,i=t.parentNode;i!=r&&!a[i.id];)i=i.parentNode;return i.id&&a[i.id]},_unmarkTargetAnchor:function(){this.targetAnchor&&(this._removeItemClass(this.targetAnchor.rowNode,this.dropPosition),this.targetAnchor=null,this.targetBox=null,this.dropPosition=null)},_markDndStatus:function(e){this._changeState("Source",e?"Copied":"Moved")}})});//# sourceMappingURL=dndSource.js.map